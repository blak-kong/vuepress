<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>js内存泄露 | 前端技术文档</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="手写源码系列！深入系列！">
    <link rel="preload" href="/assets/css/0.styles.65949c32.css" as="style"><link rel="preload" href="/assets/js/app.f3221676.js" as="script"><link rel="preload" href="/assets/js/2.02e5b305.js" as="script"><link rel="preload" href="/assets/js/24.0e831d19.js" as="script"><link rel="prefetch" href="/assets/js/10.5ab39bad.js"><link rel="prefetch" href="/assets/js/11.34ab3f99.js"><link rel="prefetch" href="/assets/js/12.48619748.js"><link rel="prefetch" href="/assets/js/13.647b1675.js"><link rel="prefetch" href="/assets/js/14.5f9dfcd0.js"><link rel="prefetch" href="/assets/js/15.fd2c72b3.js"><link rel="prefetch" href="/assets/js/16.43d2e735.js"><link rel="prefetch" href="/assets/js/17.f1e6d245.js"><link rel="prefetch" href="/assets/js/18.75786f12.js"><link rel="prefetch" href="/assets/js/19.d6d825ec.js"><link rel="prefetch" href="/assets/js/20.07f193fb.js"><link rel="prefetch" href="/assets/js/21.7f7f7c5f.js"><link rel="prefetch" href="/assets/js/22.9d6466f6.js"><link rel="prefetch" href="/assets/js/23.fd0df2e3.js"><link rel="prefetch" href="/assets/js/25.064c05fd.js"><link rel="prefetch" href="/assets/js/26.ac2883e8.js"><link rel="prefetch" href="/assets/js/27.479cd0d1.js"><link rel="prefetch" href="/assets/js/28.6b237c22.js"><link rel="prefetch" href="/assets/js/29.3e3e6957.js"><link rel="prefetch" href="/assets/js/3.6c850e2c.js"><link rel="prefetch" href="/assets/js/30.7f8ee621.js"><link rel="prefetch" href="/assets/js/31.c000973c.js"><link rel="prefetch" href="/assets/js/32.8b026430.js"><link rel="prefetch" href="/assets/js/33.1bee06aa.js"><link rel="prefetch" href="/assets/js/34.95282f8f.js"><link rel="prefetch" href="/assets/js/35.6655291b.js"><link rel="prefetch" href="/assets/js/36.743a8065.js"><link rel="prefetch" href="/assets/js/37.80a83a9e.js"><link rel="prefetch" href="/assets/js/38.f2fdcb01.js"><link rel="prefetch" href="/assets/js/39.dc20e655.js"><link rel="prefetch" href="/assets/js/4.632174fc.js"><link rel="prefetch" href="/assets/js/40.54789943.js"><link rel="prefetch" href="/assets/js/41.e5e21835.js"><link rel="prefetch" href="/assets/js/42.1b78d0a4.js"><link rel="prefetch" href="/assets/js/43.63ae8d31.js"><link rel="prefetch" href="/assets/js/44.72a7fa31.js"><link rel="prefetch" href="/assets/js/45.b5f4938e.js"><link rel="prefetch" href="/assets/js/46.790463f8.js"><link rel="prefetch" href="/assets/js/47.11f585dd.js"><link rel="prefetch" href="/assets/js/48.7cc072c1.js"><link rel="prefetch" href="/assets/js/49.0405a1da.js"><link rel="prefetch" href="/assets/js/5.a7c985c9.js"><link rel="prefetch" href="/assets/js/50.004e1f30.js"><link rel="prefetch" href="/assets/js/51.0686bd98.js"><link rel="prefetch" href="/assets/js/52.027d60de.js"><link rel="prefetch" href="/assets/js/53.633c9fd2.js"><link rel="prefetch" href="/assets/js/6.6a1b9624.js"><link rel="prefetch" href="/assets/js/7.039f99b6.js"><link rel="prefetch" href="/assets/js/8.67a3beb1.js"><link rel="prefetch" href="/assets/js/9.ce73bc4b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.65949c32.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">前端技术文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="javascript" class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/JavaScript/JavaScript运行机制/01-javascript引擎.html" class="nav-link">
  JavaScript运行机制
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/函数/01-JavaScript中的三种函数.html" class="nav-link">
  函数
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/函数式编程/01-函数式入门.html" class="nav-link">
  函数式编程
</a></li><li class="dropdown-item"><!----> <a href="/javascript/手写api/01-Promise.html" class="nav-link">
  手写api
</a></li><li class="dropdown-item"><!----> <a href="/javascript/ES6+/01-let 和 const.html" class="nav-link">
  ES6+
</a></li><li class="dropdown-item"><!----> <a href="/构建工具/01-Gulp.html" class="nav-link">
  构建工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="构建工具" class="dropdown-title"><span class="title">构建工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/404/404.html" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/404/404.html" class="nav-link">
  gulp
</a></li></ul></div></div><div class="nav-item"><a href="https://www.lzwlook.fun" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="javascript" class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/JavaScript/JavaScript运行机制/01-javascript引擎.html" class="nav-link">
  JavaScript运行机制
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/函数/01-JavaScript中的三种函数.html" class="nav-link">
  函数
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/函数式编程/01-函数式入门.html" class="nav-link">
  函数式编程
</a></li><li class="dropdown-item"><!----> <a href="/javascript/手写api/01-Promise.html" class="nav-link">
  手写api
</a></li><li class="dropdown-item"><!----> <a href="/javascript/ES6+/01-let 和 const.html" class="nav-link">
  ES6+
</a></li><li class="dropdown-item"><!----> <a href="/构建工具/01-Gulp.html" class="nav-link">
  构建工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="构建工具" class="dropdown-title"><span class="title">构建工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/404/404.html" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/404/404.html" class="nav-link">
  gulp
</a></li></ul></div></div><div class="nav-item"><a href="https://www.lzwlook.fun" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JavaScript运行机制</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/JavaScript/JavaScript运行机制/01-javascript引擎.html" class="sidebar-link">JavaScript引擎</a></li><li><a href="/JavaScript/JavaScript运行机制/02-执行上下文.html" class="sidebar-link">js执行上下文</a></li><li><a href="/JavaScript/JavaScript运行机制/03-执行栈与执行过程.html" class="sidebar-link">js执行栈与执行过程</a></li><li><a href="/JavaScript/JavaScript运行机制/04-栈内存与堆内存.html" class="sidebar-link">js栈内存与堆内存</a></li><li><a href="/JavaScript/JavaScript运行机制/05-垃圾回收.html" class="sidebar-link">js垃圾回收</a></li><li><a href="/JavaScript/JavaScript运行机制/06-内存泄露.html" class="active sidebar-link">js内存泄露</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JavaScript/JavaScript运行机制/06-内存泄露.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/JavaScript/JavaScript运行机制/06-内存泄露.html#一、全局变量" class="sidebar-link">一、全局变量</a></li><li class="sidebar-sub-header"><a href="/JavaScript/JavaScript运行机制/06-内存泄露.html#二、闭包" class="sidebar-link">二、闭包</a></li><li class="sidebar-sub-header"><a href="/JavaScript/JavaScript运行机制/06-内存泄露.html#三、dom引用" class="sidebar-link">三、DOM引用</a></li><li class="sidebar-sub-header"><a href="/JavaScript/JavaScript运行机制/06-内存泄露.html#内存泄露的识别方法" class="sidebar-link">内存泄露的识别方法</a></li><li class="sidebar-sub-header"><a href="/JavaScript/JavaScript运行机制/06-内存泄露.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/JavaScript/JavaScript运行机制/07-事件循环.html" class="sidebar-link">js事件循环</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>前面学习了 JavaScript 的内存与垃圾回收，为了知行合一，现在再来看看常见的内存问题：内存泄露。</p> <p>JavaScript 中内存管理的主要概念是可达性。</p> <p>通过此次阅读你可以学习到:</p> <ul><li>3种常见的内存泄露</li> <li>内存泄露的识别方法</li></ul> <h2 id="一、全局变量"><a href="#一、全局变量" class="header-anchor">#</a> 一、全局变量</h2> <h4 id="未声明的变量"><a href="#未声明的变量" class="header-anchor">#</a> 未声明的变量</h4> <p>当我们在一个函数中给一个变量赋值但是却没有声明它时:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">fn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a <span class="token operator">=</span> <span class="token string">&quot;Actually, I'm a global variable&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时变量<code>a</code>相当于是<code>window</code>对象下的一个变量:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">fn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token string">&quot;Actually, I'm a global variable&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再次复习执行栈知识点：全局作用域最先入栈，在执行栈栈底，在应用关闭前，理论上不可能被垃圾回收。</p> <h4 id="使用this创建的变量"><a href="#使用this创建的变量" class="header-anchor">#</a> 使用<code>this</code>创建的变量</h4> <p>还有一种情况是这样的:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">fn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token string">&quot;Actually, I'm a global variable&quot;</span>
<span class="token punctuation">}</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们知道, 这里<code>this</code>的指向是<code>window</code>, 因此此时创建的<code>a</code>变量也会被挂载到<code>window</code>对象下.</p> <p>避免此情况的解决办法是<code>在 JavaScript 文件头部或者函数的顶部加上 'use strict'</code>, 开启严格模式, 使得<code>this</code>的指向为<code>undefined</code>, 这样就可以避免了.</p> <blockquote><p>当然如果你必须使用全局变量存储大量数据时，确保用完以后把它设置为 null 或者重新定义。</p></blockquote> <h2 id="二、闭包"><a href="#二、闭包" class="header-anchor">#</a> 二、闭包</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>s<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">b</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>参考的教程中，认为有四种情况导致内存泄露，实际上就只有两种。一种是未声明，一种是闭包。</p> <p>我们知道，内存泄露的根本原因，是堆内存无法释放内存。而堆内存无法释放的原因只有一个，引用问题。</p> <h2 id="三、dom引用"><a href="#三、dom引用" class="header-anchor">#</a> 三、DOM引用</h2> <p>对于浏览器来说，还需要考虑 DOM 元素的情况。</p> <p>如果某个变量（以及对象类型变量上的属性、元素）保留了对于 DOM 元素的引用，包括引用本页的元素或同源的 iframe 内的元素等情况，当该元素在页面上被删除时，对于它的引用很可能还被保留在变量内，这样就会造成内存泄露。</p> <h2 id="内存泄露的识别方法"><a href="#内存泄露的识别方法" class="header-anchor">#</a> 内存泄露的识别方法</h2> <p>上面👆介绍了这么多种可能会造成内存泄露的情况, 那么有没有什么实际的办法让我们看到内存泄露的表现呢?</p> <p>当然是有的. 现在常用的是以下2种方式:</p> <ul><li><code>Chrome</code>浏览器的控制台<code>Performance</code>或<code>Memory</code></li> <li><code>Node</code>提供的<code>process.memoryUsage</code>方法</li></ul> <h3 id="chrome浏览器的控制台performance或memory"><a href="#chrome浏览器的控制台performance或memory" class="header-anchor">#</a> <code>Chrome</code>浏览器的控制台<code>Performance</code>或<code>Memory</code></h3> <p>Chrome 浏览器查看内存占用，按照以下步骤操作。</p> <ol><li>在网页上右键, 点击“检查”打开控制台(<code>Mac</code>快捷键<code>option+command+i</code>);</li> <li>选择<code>Performance</code>面板(很多教材中用的是<code>Timeline</code>面板, 不知道是不是版本的原因);</li> <li>勾选<code>Memory</code>, 然后点击左上角的小黑点<code>Record</code>开始录制;</li> <li>点击弹窗中的<code>Stop</code>结束录制, 面板上就会显示这段时间的内存占用情况。</li></ol> <p><img src="https://user-gold-cdn.xitu.io/2020/1/5/16f741f542a25cb2?w=2250&amp;h=1786&amp;f=png&amp;s=141471" alt=""></p> <p><img src="https://user-gold-cdn.xitu.io/2020/1/5/16f74223bf9dc5e8?w=2252&amp;h=1830&amp;f=png&amp;s=368043" alt=""></p> <p>如果内存的使用情况一直在做增量, 那么就是内存泄露了:</p> <p><img src="https://user-gold-cdn.xitu.io/2020/1/5/16f741433fd0e0be?w=2262&amp;h=1826&amp;f=png&amp;s=392053" alt=""></p> <h3 id="node提供的process-memoryusage方法"><a href="#node提供的process-memoryusage方法" class="header-anchor">#</a> <code>Node</code>提供的<code>process.memoryUsage</code>方法</h3> <p>另一个就是<code>Node</code>提供的<code>process.memoryUsage</code>方法, 这一块我用的不是很多, 这里就贴上教材:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// { rss: 27709440,</span>
<span class="token comment">//  heapTotal: 5685248,</span>
<span class="token comment">//  heapUsed: 3449392,</span>
<span class="token comment">//  external: 8772 }</span>
</code></pre></div><p>process.memoryUsage返回一个对象，包含了 Node 进程的内存占用信息。该对象包含四个字段，单位是字节，含义如下:</p> <div class="language- extra-class"><pre class="language-text"><code>rss（resident set size）：所有内存占用，包括指令区和堆栈。
heapTotal：&quot;堆&quot;占用的内存，包括用到的和没用到的。
heapUsed：用到的堆的部分。
external： V8 引擎内部的 C++ 对象占用的内存。
</code></pre></div><p>判断内存泄露, 是看<code>heapUsed</code>字段.</p> <p>对于内存泄露的详细调试方法，可以查看阮一峰的教程。</p> <p><a href="http://www.ruanyifeng.com/blog/2017/04/memory-leak.html" target="_blank" rel="noopener noreferrer">JavaScript 内存泄漏教程 - 阮一峰的网络日志<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>总的来说, 常见的内存泄露包括:</p> <ul><li>意外的全局变量</li> <li>脱离DOM的引用</li> <li>闭包</li></ul> <p>如何避免内存泄露:</p> <ul><li>注意程序逻辑，避免“死循环”</li> <li>减少不必要的全局变量，或者生命周期较长的对象，及时对无用的数据进行垃圾回收</li> <li>避免创建过多的对象</li></ul> <p><a href="https://github.com/LinDaiDai/niubility-coding-js" target="_blank" rel="noopener noreferrer">霖呆呆的blog<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/JavaScript/JavaScript运行机制/05-垃圾回收.html" class="prev">
        js垃圾回收
      </a></span> <span class="next"><a href="/JavaScript/JavaScript运行机制/07-事件循环.html">
        js事件循环
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f3221676.js" defer></script><script src="/assets/js/2.02e5b305.js" defer></script><script src="/assets/js/24.0e831d19.js" defer></script>
  </body>
</html>
